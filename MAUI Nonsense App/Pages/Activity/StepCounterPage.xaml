<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="MAUI_Nonsense_App.Pages.Activity.StepCounterPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:controls="clr-namespace:MAUI_Nonsense_App.Controls"
    xmlns:helpers="clr-namespace:MAUI_Nonsense_App.Helpers"
    Title="Activity">

    <ContentPage.Resources>
        <ResourceDictionary>
            <Color x:Key="CardBg">#F3F4F6</Color>
            <Color x:Key="BorderCol">#E5E7EB</Color>
            <Color x:Key="TextPrimary">#111827</Color>
            <Color x:Key="TextSecondary">#6B7280</Color>
            <Color x:Key="TrackBg">#E5E7EB</Color>
            <Color x:Key="TrackStroke">#D1D5DB</Color>
            <Color x:Key="TrackFill">#22C55E</Color>

            <Style TargetType="Frame">
                <Setter Property="HasShadow" Value="True"/>
                <Setter Property="CornerRadius" Value="16"/>
                <Setter Property="BackgroundColor" Value="{StaticResource CardBg}"/>
                <Setter Property="Padding" Value="16"/>
            </Style>

            <Style x:Key="ResetButton" TargetType="Button">
                <Setter Property="BackgroundColor" Value="#E5E7EB"/>
                <Setter Property="TextColor" Value="{StaticResource TextPrimary}"/>
                <Setter Property="CornerRadius" Value="16"/>
                <Setter Property="Padding" Value="18,12"/>
                <Setter Property="FontSize" Value="14"/>
                <Setter Property="HorizontalOptions" Value="Fill"/>
                <Setter Property="VerticalOptions" Value="Center"/>
            </Style>

            <helpers:MultiplyConverter x:Key="MultiplyConverter" />
            <helpers:ProgressToWidthConverter x:Key="ProgressToWidthConverter" MinPixels="30" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="16">

            <!-- TODAY CARD -->
            <Frame>
                <VerticalStackLayout Spacing="14">

                    <!-- header above the bar -->
                    <Label Text="Today’s results"
                           FontSize="16"
                           TextColor="{StaticResource TextSecondary}" />

                    <!-- LAYERED PROGRESS BAR (text always visible) -->
                    <Grid x:Name="ProgressHost" HeightRequest="32">
                        <!-- background track -->
                        <Border Background="{StaticResource TrackBg}"
                                Stroke="{StaticResource TrackStroke}"
                                StrokeThickness="1">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="16" />
                            </Border.StrokeShape>
                        </Border>

                        <!-- green fill (independent of label) -->
                        <Border Background="{StaticResource TrackFill}"
                            HorizontalOptions="Start"
                            Margin="2">
                            <!-- small inset so rounded ends look nicer -->
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="16" />
                            </Border.StrokeShape>
                            <Border.WidthRequest>
                                <MultiBinding Converter="{StaticResource ProgressToWidthConverter}">
                                    <Binding Source="{x:Reference ProgressHost}" Path="Width" />
                                    <Binding Path="GoalProgress" />
                                </MultiBinding>
                            </Border.WidthRequest>
                        </Border>

                        <!-- centered label OVER the bar -->
                        <Label
                            Padding="12,0"
                            FontSize="14" FontAttributes="Bold"
                            TextColor="{StaticResource TextPrimary}"
                            HorizontalOptions="Center" VerticalOptions="Center">
                            <Label.Text>
                                <!-- Escape StringFormat so XAML won't treat it as markup -->
                                <MultiBinding StringFormat="{}{0:N0} / {1:N0}">
                                    <Binding Path="TodaySteps" />
                                    <Binding Path="DailyGoal" />
                                </MultiBinding>
                            </Label.Text>
                        </Label>
                    </Grid>

                    <!-- today’s metrics under the bar -->
                    <Grid ColumnDefinitions="*,*,*">
                        <VerticalStackLayout Grid.Column="0" Spacing="2" HorizontalOptions="Center">
                            <Label Text="{Binding DistanceKm, StringFormat='{0:F2}'}"
                                   TextColor="{StaticResource TextPrimary}"
                                   FontSize="18" FontAttributes="Bold"/>
                            <Label Text="Km" TextColor="{StaticResource TextSecondary}" FontSize="12"/>
                        </VerticalStackLayout>

                        <VerticalStackLayout Grid.Column="1" Spacing="2" HorizontalOptions="Center">
                            <Label Text="{Binding Calories, StringFormat='{0:F1}'}"
                                   TextColor="{StaticResource TextPrimary}"
                                   FontSize="18" FontAttributes="Bold"/>
                            <Label Text="Calories" TextColor="{StaticResource TextSecondary}" FontSize="12"/>
                        </VerticalStackLayout>

                        <VerticalStackLayout Grid.Column="2" Spacing="2" HorizontalOptions="Center">
                            <Label Text="{Binding ActiveTimeText}"
                                   TextColor="{StaticResource TextPrimary}"
                                   FontSize="18" FontAttributes="Bold"/>
                            <Label Text="Time" TextColor="{StaticResource TextSecondary}" FontSize="12"/>
                        </VerticalStackLayout>
                    </Grid>
                </VerticalStackLayout>

                <!-- Open DAILY report -->
                <Frame.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnOpenReportDaily"/>
                </Frame.GestureRecognizers>
            </Frame>

            <!-- DAILY AVERAGE -->
            <Frame>
                <Grid RowDefinitions="Auto,Auto">
                    <Label Grid.Row="0" Text="Daily average" FontSize="16" TextColor="{StaticResource TextSecondary}" />
                    <Grid Grid.Row="1" ColumnDefinitions="*,*,*,*" Margin="0,10,0,0">
                        <VerticalStackLayout Grid.Column="0" Spacing="2" HorizontalOptions="Center">
                            <Label Text="{Binding SevenDayAverage}" FontSize="18" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                            <Label Text="Steps" FontSize="12" TextColor="{StaticResource TextSecondary}"/>
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="1" Spacing="2" HorizontalOptions="Center">
                            <Label Text="{Binding SevenDayAvgDistanceKm, StringFormat='{0:F2}'}" FontSize="18" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                            <Label Text="Km" FontSize="12" TextColor="{StaticResource TextSecondary}"/>
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="2" Spacing="2" HorizontalOptions="Center">
                            <Label Text="{Binding SevenDayAvgCalories, StringFormat='{0:F1}'}" FontSize="18" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                            <Label Text="Calories" FontSize="12" TextColor="{StaticResource TextSecondary}"/>
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="3" Spacing="2" HorizontalOptions="Center">
                            <Label Text="{Binding SevenDayAvgTimeText}" FontSize="18" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                            <Label Text="Time" FontSize="12" TextColor="{StaticResource TextSecondary}"/>
                        </VerticalStackLayout>
                    </Grid>
                </Grid>
                <Frame.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnOpenReportDaily"/>
                </Frame.GestureRecognizers>
            </Frame>

            <!-- THIS WEEK -->
            <Frame>
                <VerticalStackLayout Spacing="10">
                    <Label Text="This week" FontSize="16" TextColor="{StaticResource TextSecondary}" />
                    <Grid ColumnDefinitions="*,*,*,*,*,*,*" ColumnSpacing="8">
                        <VerticalStackLayout Grid.Column="0" Spacing="0" HorizontalOptions="Center">
                            <controls:RadialGoalIcon Progress="{Binding WeekDays[0].Progress}" Achieved="{Binding WeekDays[0].Achieved}" Size="32" TranslationX="-6"/>
                            <Label Text="{Binding WeekDays[0].Abbrev}" Margin="0,8,0,0" FontSize="12" TextColor="{StaticResource TextSecondary}" HorizontalTextAlignment="Center"/>
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="1" Spacing="0" HorizontalOptions="Center">
                            <controls:RadialGoalIcon Progress="{Binding WeekDays[1].Progress}" Achieved="{Binding WeekDays[1].Achieved}" Size="32" TranslationX="-6"/>
                            <Label Text="{Binding WeekDays[1].Abbrev}" Margin="0,8,0,0" FontSize="12" TextColor="{StaticResource TextSecondary}" HorizontalTextAlignment="Center"/>
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="2" Spacing="0" HorizontalOptions="Center">
                            <controls:RadialGoalIcon Progress="{Binding WeekDays[2].Progress}" Achieved="{Binding WeekDays[2].Achieved}" Size="32" TranslationX="-6"/>
                            <Label Text="{Binding WeekDays[2].Abbrev}" Margin="0,8,0,0" FontSize="12" TextColor="{StaticResource TextSecondary}" HorizontalTextAlignment="Center"/>
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="3" Spacing="0" HorizontalOptions="Center">
                            <controls:RadialGoalIcon Progress="{Binding WeekDays[3].Progress}" Achieved="{Binding WeekDays[3].Achieved}" Size="32" TranslationX="-6"/>
                            <Label Text="{Binding WeekDays[3].Abbrev}" Margin="0,8,0,0" FontSize="12" TextColor="{StaticResource TextSecondary}" HorizontalTextAlignment="Center"/>
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="4" Spacing="0" HorizontalOptions="Center">
                            <controls:RadialGoalIcon Progress="{Binding WeekDays[4].Progress}" Achieved="{Binding WeekDays[4].Achieved}" Size="32" TranslationX="-6"/>
                            <Label Text="{Binding WeekDays[4].Abbrev}" Margin="0,8,0,0" FontSize="12" TextColor="{StaticResource TextSecondary}" HorizontalTextAlignment="Center"/>
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="5" Spacing="0" HorizontalOptions="Center">
                            <controls:RadialGoalIcon Progress="{Binding WeekDays[5].Progress}" Achieved="{Binding WeekDays[5].Achieved}" Size="32" TranslationX="-6"/>
                            <Label Text="{Binding WeekDays[5].Abbrev}" Margin="0,8,0,0" FontSize="12" TextColor="{StaticResource TextSecondary}" HorizontalTextAlignment="Center"/>
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="6" Spacing="0" HorizontalOptions="Center">
                            <controls:RadialGoalIcon Progress="{Binding WeekDays[6].Progress}" Achieved="{Binding WeekDays[6].Achieved}" Size="32" TranslationX="-6"/>
                            <Label Text="{Binding WeekDays[6].Abbrev}" Margin="0,8,0,0" FontSize="12" TextColor="{StaticResource TextSecondary}" HorizontalTextAlignment="Center"/>
                        </VerticalStackLayout>
                    </Grid>
                </VerticalStackLayout>
                <Frame.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnOpenReportWeekly"/>
                </Frame.GestureRecognizers>
            </Frame>

            <!-- ALL-TIME RESULTS -->
            <Frame>
                <VerticalStackLayout Spacing="10">
                    <Label Text="All-time results" FontSize="16" TextColor="{StaticResource TextSecondary}" />
                    <Grid ColumnDefinitions="*,*,*">
                        <VerticalStackLayout Grid.Column="0" Spacing="2" HorizontalOptions="Center">
                            <Label Text="{Binding AllTimeSteps, StringFormat='{0:N0}'}"
                                   TextColor="{StaticResource TextPrimary}"
                                   FontSize="18" FontAttributes="Bold"/>
                            <Label Text="Steps" TextColor="{StaticResource TextSecondary}" FontSize="12"/>
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="1" Spacing="2" HorizontalOptions="Center">
                            <Label Text="{Binding AllTimeDistanceKm, StringFormat='{0:F2}'}"
                                   TextColor="{StaticResource TextPrimary}"
                                   FontSize="18" FontAttributes="Bold"/>
                            <Label Text="Km" TextColor="{StaticResource TextSecondary}" FontSize="12"/>
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="2" Spacing="2" HorizontalOptions="Center">
                            <Label Text="{Binding AllTimeCalories, StringFormat='{0:F1}'}"
                                   TextColor="{StaticResource TextPrimary}"
                                   FontSize="18" FontAttributes="Bold"/>
                            <Label Text="Calories" TextColor="{StaticResource TextSecondary}" FontSize="12"/>
                        </VerticalStackLayout>
                    </Grid>
                </VerticalStackLayout>
                <Frame.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnOpenReportMonthly"/>
                </Frame.GestureRecognizers>
            </Frame>

            <!-- RESET ROW -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="12" Margin="0,4,0,0">
                <Button Grid.Column="0"
                        Text="Reset today"
                        Style="{StaticResource ResetButton}"
                        Clicked="OnResetTodayClicked"/>
                <Button Grid.Column="1"
                        Text="Reset all data"
                        Style="{StaticResource ResetButton}"
                        Clicked="OnResetAllClicked"/>
            </Grid>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
